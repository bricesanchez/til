<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><title>Authenticating with AWS Elasticsearch â€” Today Icelab Learnt</title><link href="/assets/public.css" rel="stylesheet" type="text/css" /><script src="/assets/public.js" type="text/javascript"></script></head><body><aside class="sidebar" id="sidebar"><a class="close-sidebar" href="#">Hide topics &rsaquo;</a><div class="sidebar-topic"><a href="/tags/react">react</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/js">js</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/ruby">ruby</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/aws">aws</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/accessibility">accessibility</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/social">social</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/performance">performance</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/git">git</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/css">css</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/rails">rails</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/slim">slim</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/seo">seo</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/postgres">postgres</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/debugging">debugging</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/testing">testing</a><span class="topic-count"> (<i>1</i>)</span></div><div class="sidebar-topic"><a href="/tags/processing">processing</a><span class="topic-count"> (<i>1</i>)</span></div></aside><div class="header"><a class="header__logo" href="http://www.icelab.com.au"></a><a href="/" class="header__til-text">Today Icelab Learnt</a><a class="header__view-topics open-sidebar" href="#sidebar"> &lsaquo; View topics</a></div><div class="container"><div class="article"><a href="/" class="article__title">Authenticating with AWS Elasticsearch</a><div class="article__meta">Daniel Nitsikopolous, 26 April 2016 </div><div class="article__content" data-view-highlight=""><p>The AWS Elasticseach service offers authentication via an IAM user, or by whitelisting IPs.</p>

<p>Here&rsquo;s how to use IAM credentials to sign requests to the service when using Faraday and how to hook that into the Ruby elasticsearch gem.</p>

<p>To sign requests using Faraday, you can use a gem called <a href="https://github.com/winebarrel/faraday_middleware-aws-signers-v4">faraday_middleware-aws-signers-v4</a>, which provides a middleware that will sign your requests.</p>

<pre><code class="ruby">require &#39;faraday_middleware&#39;
require &#39;faraday_middleware/aws_signers_v4&#39;

conn = Faraday.new(url: &#39;address-of-your-AWS-es-service&#39;) do |faraday|
  faraday.request :aws_signers_v4, {
    credentials: Aws::Credentials.new(ENV[&#39;AWS_ACCESS_KEY_ID&#39;], ENV[&#39;AWS_SECRET_ACCESS_KEY&#39;]),
    service_name: &#39;es&#39;,
    region: &#39;ap-southeast-2&#39;
  }

  faraday.adapter :typhoeus
end
</code></pre>

<p>To get the client provided by the elasticsearch gem to use your Faraday configuation, you can pass that configuration to it like so:</p>

<pre><code class="ruby">faraday_config = lambda do |faraday|
  faraday.request :aws_signers_v4, {
    credentials: Aws::Credentials.new(
      ENV[&quot;ELASTICSEARCH_AWS_ACCESS_KEY_ID&quot;],
      ENV[&quot;ELASTICSEARCH_AWS_SECRET_ACCESS_KEY&quot;]
      ),
      service_name: &quot;es&quot;,
      region: ENV[&quot;ELASTICSEARCH_AWS_REGION&quot;]
    }
    faraday.adapter :typhoeus
  end

elasticsearch_host_config = {
  host:   ENV[&quot;ELASTICSEARCH_HOST&quot;],
  port:   ENV[&quot;ELASTICSEARCH_PORT&quot;],
  scheme: ENV[&quot;ELASTICSEARCH_SCHEME&quot;]
}

transport = Elasticsearch::Transport::Transport::HTTP::Faraday.new(hosts: [elasticsearch_host_config], &amp;faraday_config)

client = Elasticsearch::Client.new(transport: transport)
</code></pre>

<p>You can then use the client object as usual, and you&rsquo;ll get automatically signed requests.</p>
</div><a href="/tags/ruby" class="article__tag">ruby</a><a href="/tags/aws" class="article__tag">aws</a></div></div></body></html>