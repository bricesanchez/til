<!DOCTYPE html><html><head><meta charset="utf-8" /><title>Authenticating with AWS Elasticsearch â€” Today Icelab Learnt</title><link href="/assets/public.css" rel="stylesheet" type="text/css" /><script src="/assets/public.js" type="text/javascript"></script></head><body><h1><a href="/">Today Icelab Learnt</a></h1><h1>Authenticating with AWS Elasticsearch</h1><div class="content" data-view-highlight=""><p>The AWS Elasticseach service offers authentication via an IAM user, or by whitelisting IPs.</p>

<p>Here&rsquo;s how to use IAM credentials to sign requests to the service when using Faraday and how to hook that into the Ruby elasticsearch gem.</p>

<p>To sign requests using Faraday, you can use a gem called <a href="https://github.com/winebarrel/faraday_middleware-aws-signers-v4">faraday_middleware-aws-signers-v4</a>, which provides a middleware that will sign your requests.</p>

<pre><code class="ruby">require &#39;faraday_middleware&#39;
require &#39;faraday_middleware/aws_signers_v4&#39;

conn = Faraday.new(url: &#39;address-of-your-AWS-es-service&#39;) do |faraday|
  faraday.request :aws_signers_v4, {
    credentials: Aws::Credentials.new(ENV[&#39;AWS_ACCESS_KEY_ID&#39;], ENV[&#39;AWS_SECRET_ACCESS_KEY&#39;]),
    service_name: &#39;es&#39;,
    region: &#39;ap-southeast-2&#39;
  }

  faraday.adapter :typhoeus
end
</code></pre>

<p>To get the client provided by the elasticsearch gem to use your Faraday configuation, you can pass that configuration to it like so:</p>

<pre><code class="ruby">faraday_config = lambda do |faraday|
  faraday.request :aws_signers_v4, {
    credentials: Aws::Credentials.new(
      ENV[&quot;ELASTICSEARCH_AWS_ACCESS_KEY_ID&quot;],
      ENV[&quot;ELASTICSEARCH_AWS_SECRET_ACCESS_KEY&quot;]
      ),
      service_name: &quot;es&quot;,
      region: ENV[&quot;ELASTICSEARCH_AWS_REGION&quot;]
    }
    faraday.adapter :typhoeus
  end

elasticsearch_host_config = {
  host:   ENV[&quot;ELASTICSEARCH_HOST&quot;],
  port:   ENV[&quot;ELASTICSEARCH_PORT&quot;],
  scheme: ENV[&quot;ELASTICSEARCH_SCHEME&quot;]
}

transport = Elasticsearch::Transport::Transport::HTTP::Faraday.new(hosts: [elasticsearch_host_config], &amp;faraday_config)

client = Elasticsearch::Client.new(transport: transport)
</code></pre>

<p>You can then use the client object as usual, and you&rsquo;ll get automatically signed requests.</p>
</div><div class="tags"><a href="/tags/ruby">ruby</a>, <a href="/tags/aws">aws</a></div><div class="tags"><h2>All tags</h2><a href="/tags/react">react</a><a href="/tags/js">js</a><a href="/tags/ruby">ruby</a><a href="/tags/aws">aws</a><a href="/tags/accessibility">accessibility</a><a href="/tags/social">social</a><a href="/tags/performance">performance</a><a href="/tags/git">git</a><a href="/tags/css">css</a><a href="/tags/rails">rails</a><a href="/tags/slim">slim</a><a href="/tags/seo">seo</a><a href="/tags/postgres">postgres</a><a href="/tags/debugging">debugging</a><a href="/tags/testing">testing</a><a href="/tags/processing">processing</a></div></body></html>