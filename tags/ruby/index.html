<!DOCTYPE html><html><head><meta charset="utf-8" /><title> — Today Icelab Learnt</title><link href="/assets/public.css" rel="stylesheet" type="text/css" /><script src="/assets/public.js" type="text/javascript"></script></head><body><h1><a href="/">Today Icelab Learnt</a></h1><h1>Articles tagged ruby</h1><div class="articles"><h1><a href="/symbolize-keys/">Symbolize keys</a></h1><div class="content" data-view-highlight=""><p>If you&rsquo;re writing plain old Ruby you can symbolize the keys of a hash with the following:</p>

<p><code>hash.inject({}){|memo,(k,v)| memo[k.to_sym] = v; memo}</code></p>

<p>This does the following:</p>

<pre><code>hash = {&quot;hello&quot; =&gt; &quot;jojo&quot;}
hash.inject({}){|memo,(k,v)| memo[k.to_sym] = v; memo}
=&gt; {:hello=&gt;&quot;jojo&quot;}
</code></pre>

<p>However if you&rsquo;re doing this in a web application you may want to make a module to make hash and array data transformations easily available to you. In most of our apps we would use <a href="https://github.com/solnic/transproc">transproc</a> to help us with this — if you&rsquo;re working in one of Icelab&rsquo;s Rodakase apps this will be available to you.</p>

<pre><code>require &quot;transproc/all&quot;

module Functions
  extend Transproc::Registry

  import Transproc::HashTransformations
  import Transproc::ArrayTransformations

  def self.t(*args)
    self[*args]
  end
end

Functions.t(:symbolize_keys)[{&quot;foo&quot; =&gt; &quot;bar&quot;}]
# =&gt; {foo: &quot;bar&quot;}
</code></pre>

<p>If you are using Rails then you can use the method <code>hash.symbolize_keys</code> or the destructive version <code>hash.symbolize_keys!</code><br>
(both made available via ActiveSupport).</p>
</div><div class="tags"><a href="/tags/ruby">ruby</a></div><h1><a href="/pry-is-amazing/">Pry is amazing</a></h1><div class="content" data-view-highlight=""><p><a href="https://github.com/pry/pry">Pry</a> is amazing! It has a whole bunch of helpful shortcuts you can use while working in a session.</p>

<p>I found the <a href="https://github.com/pry/pry/wiki/Exceptions">exception handling shortcuts</a> particularly helpful. <code>_ex_</code> will give you the last raised exception, and <code>wtf?</code> will show you a stacktrace from that exception (which is helpful, since stacktraces aren&rsquo;t normally shown in interactive terminal sessions like this). Hilariously, you can add more question marks or exclamation marks on the end to see more detail.</p>

<p>If you work with Ruby app consoles regularly, you&rsquo;d do yourself a favour to give the <a href="https://github.com/pry/pry/wiki">Pry Wiki</a> a good read!</p>
</div><div class="tags"><a href="/tags/ruby">ruby</a>, <a href="/tags/debugging">debugging</a></div><h1><a href="/aws-elasticsearch-authentication/">Authenticating with AWS Elasticsearch</a></h1><div class="content" data-view-highlight=""><p>The AWS Elasticseach service offers authentication via an IAM user, or by whitelisting IPs.</p>

<p>Here&rsquo;s how to use IAM credentials to sign requests to the service when using Faraday and how to hook that into the Ruby elasticsearch gem.</p>

<p>To sign requests using Faraday, you can use a gem called <a href="https://github.com/winebarrel/faraday_middleware-aws-signers-v4">faraday_middleware-aws-signers-v4</a>, which provides a middleware that will sign your requests.</p>

<pre><code class="ruby">require &#39;faraday_middleware&#39;
require &#39;faraday_middleware/aws_signers_v4&#39;

conn = Faraday.new(url: &#39;address-of-your-AWS-es-service&#39;) do |faraday|
  faraday.request :aws_signers_v4, {
    credentials: Aws::Credentials.new(ENV[&#39;AWS_ACCESS_KEY_ID&#39;], ENV[&#39;AWS_SECRET_ACCESS_KEY&#39;]),
    service_name: &#39;es&#39;,
    region: &#39;ap-southeast-2&#39;
  }

  faraday.adapter :typhoeus
end
</code></pre>

<p>To get the client provided by the elasticsearch gem to use your Faraday configuation, you can pass that configuration to it like so:</p>

<pre><code class="ruby">faraday_config = lambda do |faraday|
  faraday.request :aws_signers_v4, {
    credentials: Aws::Credentials.new(
      ENV[&quot;ELASTICSEARCH_AWS_ACCESS_KEY_ID&quot;],
      ENV[&quot;ELASTICSEARCH_AWS_SECRET_ACCESS_KEY&quot;]
      ),
      service_name: &quot;es&quot;,
      region: ENV[&quot;ELASTICSEARCH_AWS_REGION&quot;]
    }
    faraday.adapter :typhoeus
  end

elasticsearch_host_config = {
  host:   ENV[&quot;ELASTICSEARCH_HOST&quot;],
  port:   ENV[&quot;ELASTICSEARCH_PORT&quot;],
  scheme: ENV[&quot;ELASTICSEARCH_SCHEME&quot;]
}

transport = Elasticsearch::Transport::Transport::HTTP::Faraday.new(hosts: [elasticsearch_host_config], &amp;faraday_config)

client = Elasticsearch::Client.new(transport: transport)
</code></pre>

<p>You can then use the client object as usual, and you&rsquo;ll get automatically signed requests.</p>
</div><div class="tags"><a href="/tags/ruby">ruby</a>, <a href="/tags/aws">aws</a></div><h1><a href="/manually-incrementing-count-columns/">Manually incrementing count columns in rails</a></h1><div class="content" data-view-highlight=""><p>Adding a counter cache column to a model is a common optimisation we make in order to avoid unnecessary queries when trying to aggregate data associated with that particular model. Rails provides us with a number of ways to maintain the counter cache column&rsquo;s value. The first is to follow the rails convention and add <code>counter_cache: true</code> to a <code>belongs_to</code> association and ensure we have a correctly named <code>*_count</code> column.</p>

<p>The other way to do it, is manually. In this case rails provides us with a few convenience methods to increment a given column.</p>

<p>The first is <code>ActiveRecord::Base#increment!(attribute, by)</code>.</p>

<p><code>increment!</code> is defined as:</p>

<pre><code class="ruby">def increment!(attribute, by = 1)
  increment(attribute, by).update_attribute(attribute, self[attribute])
end
</code></pre>

<p>and <code>increment</code> is defined as:</p>

<pre><code class="ruby">def increment(attribute, by = 1)
  self[attribute] ||= 0
  self[attribute] += by
  self
end
</code></pre>

<p>Which means that we&rsquo;re first fetching the current attribute&rsquo;s value, incrementing it then passing it on to <code>update_attribute</code> before it can be saved. This method leads to a non-atomic database operation, that is to say that at one point, the count is different in memory than it is in the database (which can lead to race conditions).</p>

<p>The second is <code>ActiveRecord::Base#increment_counter(column_name, record_id)</code>.</p>

<p><code>increment_counter</code> is defined as:</p>

<pre><code class="ruby">def increment_counter(counter_name, id)
  update_counters(id, counter_name =&gt; 1)
end
</code></pre>

<p>which executes SQL like:</p>

<pre><code class="SQL">UPDATE &quot;table_name&quot;
  SET &quot;counter_name&quot; = &quot;counter_name&quot; + 1
  WHERE id = 1
</code></pre>

<p>This means that we now have an atomic operation and the counter cache value is the same across the system.</p>

<p>Docs:</p>

<ul>
<li><em><a href="http://apidock.com/rails/ActiveRecord/Base/increment!">increment!</a></em></li>
<li><em>[increment_counter](<a href="http://apidock.com/rails/ActiveRecord/Base/increment">http://apidock.com/rails/ActiveRecord/Base/increment</a></em>counter/class)_</li>
</ul>
</div><div class="tags"><a href="/tags/rails">rails</a>, <a href="/tags/ruby">ruby</a></div><h1><a href="/displaying-booleans-in-active-admin/">Displaying booleans in Active Admin</a></h1><div class="content" data-view-highlight=""><p>In Active Admin if you want to display a boolean propetry that doesn&rsquo;t directly map to a database column you can use <code>status_tag</code> to display the value in a fiendly way:</p>

<pre><code>column :featured do |thing|
  thing.featured? ? status_tag(&quot;yes&quot;, :ok) : status_tag(&quot;no&quot;)
end
</code></pre>

<p>There&rsquo;s a bit more info in the <em><a href="http://activeadmin.info/docs/12-arbre-components.html#status-tag">Active Admin docs</a></em> which shows you how to add classes too!</p>
</div><div class="tags"><a href="/tags/rails">rails</a>, <a href="/tags/ruby">ruby</a></div><h1><a href="/dynamic-classnames-in-slim/">Dynamic classnames in Slim</a></h1><div class="content" data-view-highlight=""><p>While glancing through one of Narinda’s pull-requests, I noticed she’d used a syntax for dynamic classnames in <a href="http://slim-lang.com/">Slim</a> that I had not seen before:</p>

<pre><code class="slim"># Aww yeah
- dynamic_classname = (truthy_test ? &#39;foo&#39; : &#39;bar&#39;)
.static-class-name-one class=[&quot;static-class-name-two&quot;, dynamic_classname]
  &#39; Foo or bar?
</code></pre>

<p>Slim will magically convert concatenate the classnames based on the truthiness of the <code>truthy_test</code>. Much more flexible (and less stinky) than the string concatenation I would usually use:</p>

<pre><code class="slim"># Eww
- dynamic_classname = (truthy_test ? &#39;foo&#39; : &#39;bar&#39;)
.static-class-name-one class=&quot;static-class-name-two #{dynamic_classname}&quot;
  &#39; Foo or bar?
</code></pre>
</div><div class="tags"><a href="/tags/slim">slim</a>, <a href="/tags/ruby">ruby</a></div><h1><a href="/string-format/">Formatting strings with C-like formatting codes.</a></h1><div class="content" data-view-highlight=""><p>I learnt this while putting together the report emails for Ticketscout.</p>

<p>Most of the time, regular string interpolation is all that we need when working with strings. Though sometimes we want a little more control over the formatting.</p>

<p>Let&rsquo;s say we have a set of numbers that we want to calculate the average for, then print that average to 1 decimal place.</p>

<pre><code class="ruby">FLOATS = [
  42.0,
  36.0,
  28.0,
  19.0,
  27.0,
  18.0,
  10.0
]
avg = FLOATS.reduce(0, :+) / FLOATS.size
&quot;Average is: #{avg}&quot; # =&gt; &quot;Average is: 25.714285714285715
&quot;Average is: #{avg.round(1)}&quot; # =&gt; &quot;Average is: 25.7
</code></pre>

<p>Normally, this is fine, but when working with some content, it may be nicer to use Ruby&rsquo;s String Format instead (especially if trying to format more complex numbers).</p>

<pre><code class="ruby">&quot;Average is %.1f&quot; % avg # =&gt; &quot;Average is 25.7&quot;
</code></pre>

<p>We can also make printing hashes a little prettier as well.</p>

<pre><code class="ruby">dog = {name: &#39;poppy&#39;,breed: &#39;labrador&#39;,colour: &#39;black&#39;}

&quot;This is #{dog[:name]}, she is a #{dog[:colour]} #{dog[:breed]}.&quot;
</code></pre>

<p>Becomes:</p>

<pre><code class="ruby">&quot;This is %{name}, she is a %{colour} %{breed}.&quot; % [dog]
</code></pre>

<p>Which, to me at least, reads a little nicer.</p>

<p><a href="http://apidock.com/ruby/Kernel/sprintf">Kernel::sprintf</a> has a more complete list of formatting strings.</p>
</div><div class="tags"><a href="/tags/ruby">ruby</a></div><h1><a href="/dynamically-adding-class-methods/">Using `Class.new` for dynamically adding class methods</a></h1><div class="content" data-view-highlight=""><p>Say you&rsquo;re building a system where you want to dynamically add some class methods to a class at a particular moment, but without leaving them around for use on the class at other times.</p>

<p>This is pretty easy if you create an anonymous subclass whenever you need to use the special class methods:</p>

<pre><code class="ruby">module MyCustomFinders
  def special_finder
    where(something: &quot;is special&quot;)
  end
end

class MyThing &lt; ActiveRecord::Base
end

Class.new(MyThing).extend(MyCustomFinders).special_finder
</code></pre>
</div><div class="tags"><a href="/tags/ruby">ruby</a></div></div><div class="tags"><h2>All tags</h2><a href="/tags/react">react</a><a href="/tags/js">js</a><a href="/tags/ruby">ruby</a><a href="/tags/aws">aws</a><a href="/tags/accessibility">accessibility</a><a href="/tags/social">social</a><a href="/tags/performance">performance</a><a href="/tags/git">git</a><a href="/tags/css">css</a><a href="/tags/rails">rails</a><a href="/tags/slim">slim</a><a href="/tags/seo">seo</a><a href="/tags/postgres">postgres</a><a href="/tags/debugging">debugging</a><a href="/tags/testing">testing</a><a href="/tags/processing">processing</a></div></body></html>