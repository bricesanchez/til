<!DOCTYPE html><html><head><meta charset="utf-8" /><title> â€” Today Icelab Learnt</title><link href="/assets/public.css" rel="stylesheet" type="text/css" /><script src="/assets/public.js" type="text/javascript"></script></head><body><h1><a href="/">Today Icelab Learnt</a></h1><h1>Articles tagged postgres</h1><div class="articles"><h1><a href="/postgres-listen-notify/">PostgreSQL as a message bus</a></h1><div class="content" data-view-highlight=""><p>PostgreSQL has its own listen/notify mechanism. It might be useful for cases when we have to manage messaging between different application processes, but would prefer to not use extra dependencies such as Redis.</p>

<p><em>process.rb</em></p>

<pre><code>CHANNEL       = &quot;slack_bot&quot;
RESET_CHANNEL = &quot;pg_restart&quot;

ActiveRecord::Base.connection_pool.with_connection do |connection|
  conn = connection.instance_variable_get(:@connection)
  begin
    conn.async_exec &quot;LISTEN #{RESET_CHANNEL}&quot;
    conn.async_exec &quot;LISTEN #{CHANNEL}&quot;
    catch(:break_loop) do
      loop do
        conn.wait_for_notify do |channel, pid, payload|
          p [channel, payload]
          throw :break_loop if channel == RESET_CHANNEL
        end
      end
    end
  rescue =&gt; error
    p [:error, error]
  ensure
    conn.async_exec &quot;UNLISTEN *&quot;
  end
end
</code></pre>

<p><em>another-process.rb</em></p>

<pre><code>User.connection.execute %Q(NOTIFY &quot;slack_bot&quot;, params)
</code></pre>
</div><div class="tags"><a href="/tags/rails">rails</a>, <a href="/tags/postgres">postgres</a></div></div><div class="tags"><h2>All tags</h2><a href="/tags/react">react</a><a href="/tags/js">js</a><a href="/tags/ruby">ruby</a><a href="/tags/aws">aws</a><a href="/tags/accessibility">accessibility</a><a href="/tags/social">social</a><a href="/tags/performance">performance</a><a href="/tags/git">git</a><a href="/tags/css">css</a><a href="/tags/rails">rails</a><a href="/tags/slim">slim</a><a href="/tags/seo">seo</a><a href="/tags/postgres">postgres</a><a href="/tags/debugging">debugging</a><a href="/tags/testing">testing</a><a href="/tags/processing">processing</a></div></body></html>